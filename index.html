<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste T√©cnico ‚Äì Geolocaliza√ß√£o Aprimorado</title>

  <style>
    * { box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    h1 { 
      color: #2c3e50;
      margin-top: 0;
      font-size: 2em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h2 { 
      color: #34495e;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      margin-top: 30px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    button { 
      padding: 12px 20px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; }
    
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-secondary:hover { background: #7f8c8d; }
    
    .box { 
      border: 1px solid #dfe6e9;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background: #ffffff;
    }
    
    .warning { background: #fff9e6; border-color: #f39c12; }
    .success { background: #d5f4e6; border-color: #27ae60; }
    .error { background: #ffeaea; border-color: #e74c3c; color: #c0392b; }
    .info { background: #e8f4f8; border-color: #3498db; }
    
    pre { 
      background: #2c3e50;
      color: #ecf0f1;
      padding: 20px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .small { font-size: 0.9em; color: #7f8c8d; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .history-item { 
      border: 1px solid #ecf0f1;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      transition: all 0.2s ease;
      background: white;
    }
    
    .history-item:hover { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateX(4px);
    }
    
    .history-info { flex: 1; }
    .history-info strong { color: #2c3e50; font-size: 1.05em; }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      margin: 5px 0;
    }
    
    .badge-gps { background: #27ae60; color: white; }
    .badge-wifi { background: #3498db; color: white; }
    .badge-wifi-aprox { background: #f39c12; color: white; }
    .badge-ip { background: #95a5a6; color: white; }
    
    .delete-btn {
      color: #e74c3c;
      cursor: pointer;
      font-size: 20px;
      padding: 0 10px;
      transition: all 0.2s ease;
    }
    
    .delete-btn:hover {
      color: #c0392b;
      transform: scale(1.2);
    }
    
    a { 
      text-decoration: none;
      color: #3498db;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    
    a:hover { color: #2980b9; text-decoration: underline; }
    
    .config-panel {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    
    .config-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      flex-wrap: wrap;
    }
    
    .config-row label {
      font-weight: 600;
      min-width: 180px;
      color: #2c3e50;
    }
    
    .config-row input {
      padding: 8px 12px;
      border: 1px solid #dfe6e9;
      border-radius: 4px;
      width: 100px;
      font-size: 14px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .export-options {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .chart-container {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .accuracy-bar {
      width: 100%;
      height: 30px;
      background: #ecf0f1;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      margin: 10px 0;
    }
    
    .accuracy-fill {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
      border-radius: 15px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }
    
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h1 { font-size: 1.5em; }
      .controls { flex-direction: column; }
      button { width: 100%; justify-content: center; }
      .stats-grid { grid-template-columns: 1fr; }
      .config-row { flex-direction: column; align-items: flex-start; }
      .config-row label { min-width: auto; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>
    <span>üåç</span>
    Teste T√©cnico de Geolocaliza√ß√£o
  </h1>

  <div class="box warning">
    <h2 style="margin-top: 0; border: none;">üéØ Objetivo</h2>
    <p class="small">
      Analisar a obten√ß√£o de geolocaliza√ß√£o pelo navegador com an√°lise avan√ßada de precis√£o,
      detec√ß√£o de duplicatas, estat√≠sticas completas e exporta√ß√£o de dados em m√∫ltiplos formatos.
    </p>
  </div>

  <div class="config-panel">
    <strong>‚öôÔ∏è Configura√ß√µes de Classifica√ß√£o</strong>
    <div class="config-row">
      <label>GPS (precis√£o at√©):</label>
      <input type="number" id="gpsMax" value="20" min="1" max="100"> metros
    </div>
    <div class="config-row">
      <label>Wi-Fi (precis√£o at√©):</label>
      <input type="number" id="wifiMax" value="200" min="1" max="500"> metros
    </div>
    <div class="config-row">
      <label>Wi-Fi Aproximado (at√©):</label>
      <input type="number" id="wifiAproxMax" value="1000" min="1" max="5000"> metros
    </div>
  </div>

  <div class="controls">
    <button class="btn-primary" onclick="obterLocalizacao()" id="btnObter">
      <span>üìç</span> Obter Localiza√ß√£o
    </button>
    <button class="btn-secondary" onclick="obterMultiplas()" id="btnMultiplas">
      <span>üìä</span> Obter 5 Consecutivas
    </button>
    <button class="btn-danger" onclick="limparHistorico()">
      <span>üóëÔ∏è</span> Excluir Hist√≥rico
    </button>
  </div>

  <div id="maps"></div>

  <div id="stats"></div>

  <h2>üìä Resultado Atual</h2>
  <pre id="resultado">Aguardando a√ß√£o...</pre>

  <h2>üïò Hist√≥rico de Localiza√ß√µes</h2>
  
  <div class="export-options">
    <button class="btn-secondary" onclick="exportarJSON()">
      <span>üíæ</span> Exportar JSON
    </button>
    <button class="btn-secondary" onclick="exportarCSV()">
      <span>üìÑ</span> Exportar CSV
    </button>
    <button class="btn-secondary" onclick="copiarParaClipboard()">
      <span>üìã</span> Copiar Dados
    </button>
  </div>
  
  <div class="box" id="historico">
    <p class="small">Nenhum registro ainda.</p>
  </div>
</div>

<script>
const CONFIG = {
  gpsMax: 20,
  wifiMax: 200,
  wifiAproxMax: 1000,
  limiteHistorico: 50,
  distanciaMinimaDuplicata: 10 // metros
};

// Fun√ß√£o para calcular dist√¢ncia entre dois pontos (Haversine)
function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Raio da Terra em metros
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) *
          Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // Dist√¢ncia em metros
}

function obterConfig() {
  return {
    gpsMax: Number(document.getElementById("gpsMax").value),
    wifiMax: Number(document.getElementById("wifiMax").value),
    wifiAproxMax: Number(document.getElementById("wifiAproxMax").value)
  };
}

function classificarOrigem(accuracy, cfg) {
  if (accuracy <= cfg.gpsMax) return { tipo: "GPS", classe: "gps" };
  if (accuracy <= cfg.wifiMax) return { tipo: "Wi-Fi", classe: "wifi" };
  if (accuracy <= cfg.wifiAproxMax) return { tipo: "Wi-Fi Aproximado", classe: "wifi-aprox" };
  return { tipo: "IP/Rede", classe: "ip" };
}

function carregarHistorico() {
  const container = document.getElementById("historico");
  const dados = JSON.parse(localStorage.getItem("geo_historico_v2")) || [];

  if (dados.length === 0) {
    container.innerHTML = '<p class="small">Nenhum registro ainda.</p>';
    atualizarEstatisticas([]);
    return;
  }

  container.innerHTML = `<p class="small">Total de registros: ${dados.length}</p>`;
  
  dados.forEach((item, index) => {
    const mapsUrl = `https://www.google.com/maps?q=${item.lat},${item.lon}`;
    const origem = classificarOrigem(item.precisao, obterConfig());

    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <div class="history-info">
        <strong>${index + 1}. ${item.data}</strong>
        <span class="badge badge-${origem.classe}">${origem.tipo}</span>
        ${item.duplicata ? '<span class="badge" style="background: #e74c3c; color: white;">DUPLICATA</span>' : ''}
        <br>
        <strong>Coordenadas:</strong> ${typeof item.lat === 'number' ? item.lat.toFixed(6) : item.lat}, ${typeof item.lon === 'number' ? item.lon.toFixed(6) : item.lon}<br>
        <strong>Precis√£o:</strong> ${item.precisao} m
        ${item.velocidade !== undefined && item.velocidade !== null ? `<br><strong>Velocidade:</strong> ${item.velocidade.toFixed(1)} m/s` : ''}
        ${item.altitude !== undefined && item.altitude !== null ? `<br><strong>Altitude:</strong> ${item.altitude.toFixed(1)} m` : ''}
        <br>
        <strong>Tempo de resposta:</strong> ${item.duracao_ms || 0} ms
        ${item.distanciaAnterior !== undefined && item.distanciaAnterior !== null ? `<br><strong>Dist√¢ncia do anterior:</strong> ${item.distanciaAnterior.toFixed(1)} m` : ''}
        <br>
        <a href="${mapsUrl}" target="_blank">üìç Abrir no Google Maps</a>
      </div>
      <div class="delete-btn" title="Excluir registro" onclick="excluirRegistro(${index})">
        ‚úñ
      </div>
    `;
    container.appendChild(div);
  });
  
  atualizarEstatisticas(dados);
}

function atualizarEstatisticas(dados) {
  const statsDiv = document.getElementById("stats");
  
  if (dados.length === 0) {
    statsDiv.innerHTML = '';
    return;
  }
  
  const precisoes = dados.map(d => d.precisao).filter(p => p !== undefined && p !== null);
  const duracoes = dados.map(d => d.duracao_ms).filter(d => d !== undefined && d !== null && d > 0);
  
  const precisaoMedia = precisoes.length > 0 ? (precisoes.reduce((a, b) => a + b, 0) / precisoes.length).toFixed(1) : '0';
  const precisaoMin = precisoes.length > 0 ? Math.min(...precisoes) : 0;
  const precisaoMax = precisoes.length > 0 ? Math.max(...precisoes) : 0;
  const duracaoMedia = duracoes.length > 0 ? (duracoes.reduce((a, b) => a + b, 0) / duracoes.length).toFixed(0) : '0';
  
  const duplicatas = dados.filter(d => d.duplicata).length;
  
  const cfg = obterConfig();
  const gps = dados.filter(d => d.precisao <= cfg.gpsMax).length;
  const wifi = dados.filter(d => d.precisao > cfg.gpsMax && d.precisao <= cfg.wifiMax).length;
  const outros = dados.length - gps - wifi;
  
  statsDiv.innerHTML = `
    <h2>üìà Estat√≠sticas</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total de Registros</div>
        <div class="stat-value">${dados.length}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Precis√£o M√©dia</div>
        <div class="stat-value">${precisaoMedia}m</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tempo M√©dio</div>
        <div class="stat-value">${duracaoMedia}ms</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Duplicatas</div>
        <div class="stat-value">${duplicatas}</div>
      </div>
    </div>
    
    <div class="chart-container">
      <strong>Distribui√ß√£o por Tipo de Origem:</strong>
      <div style="margin: 10px 0;">
        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
          <span>üì° GPS: ${gps} (${((gps/dados.length)*100).toFixed(1)}%)</span>
        </div>
        <div class="accuracy-bar">
          <div class="accuracy-fill" style="width: ${(gps/dados.length)*100}%">
            ${gps > 0 ? gps : ''}
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
          <span>üì∂ Wi-Fi: ${wifi} (${((wifi/dados.length)*100).toFixed(1)}%)</span>
        </div>
        <div class="accuracy-bar">
          <div class="accuracy-fill" style="width: ${(wifi/dados.length)*100}%; background: #3498db;">
            ${wifi > 0 ? wifi : ''}
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
          <span>üåê Outros: ${outros} (${((outros/dados.length)*100).toFixed(1)}%)</span>
        </div>
        <div class="accuracy-bar">
          <div class="accuracy-fill" style="width: ${(outros/dados.length)*100}%; background: #95a5a6;">
            ${outros > 0 ? outros : ''}
          </div>
        </div>
      </div>
    </div>
    
    <div class="box info">
      <strong>üìä Faixa de Precis√£o:</strong> ${precisaoMin}m - ${precisaoMax}m
    </div>
  `;
}

function salvarHistorico(registro) {
  const historico = JSON.parse(localStorage.getItem("geo_historico_v2")) || [];
  
  // Verificar duplicatas
  if (historico.length > 0) {
    const ultimo = historico[0];
    const distancia = calcularDistancia(
      ultimo.lat, ultimo.lon,
      registro.lat, registro.lon
    );
    
    registro.distanciaAnterior = distancia;
    
    if (distancia < CONFIG.distanciaMinimaDuplicata) {
      registro.duplicata = true;
    }
  }
  
  historico.unshift(registro);
  if (historico.length > CONFIG.limiteHistorico) {
    historico.pop();
  }
  
  localStorage.setItem("geo_historico_v2", JSON.stringify(historico));
  carregarHistorico();
}

function excluirRegistro(index) {
  const historico = JSON.parse(localStorage.getItem("geo_historico_v2")) || [];
  historico.splice(index, 1);
  localStorage.setItem("geo_historico_v2", JSON.stringify(historico));
  carregarHistorico();
}

function limparHistorico() {
  if (confirm("Deseja excluir todo o hist√≥rico de localiza√ß√µes?")) {
    localStorage.removeItem("geo_historico_v2");
    carregarHistorico();
  }
}

function obterLocalizacao() {
  const output = document.getElementById("resultado");
  const mapsDiv = document.getElementById("maps");
  const btnObter = document.getElementById("btnObter");
  
  mapsDiv.innerHTML = "";
  btnObter.disabled = true;
  btnObter.innerHTML = '<span class="loading"></span> Obtendo...';

  if (!navigator.geolocation) {
    output.textContent = "‚ùå Geolocaliza√ß√£o n√£o suportada por este navegador.";
    btnObter.disabled = false;
    btnObter.innerHTML = '<span>üìç</span> Obter Localiza√ß√£o';
    return;
  }

  const inicio = new Date();
  output.textContent = "‚è≥ Solicitando localiza√ß√£o...\nIn√≠cio: " + inicio.toISOString();

  // Timeout de seguran√ßa adicional
  const timeoutId = setTimeout(() => {
    output.innerHTML = `<div class="box error">
      <strong>‚ö†Ô∏è Timeout de Seguran√ßa</strong><br>
      A solicita√ß√£o est√° demorando muito. Isso pode indicar:<br>
      - Problema com o GPS do dispositivo<br>
      - Sinal fraco ou ausente<br>
      - Configura√ß√µes de localiza√ß√£o desabilitadas<br><br>
      Tente novamente ou verifique as configura√ß√µes do seu dispositivo.
    </div>`;
    btnObter.disabled = false;
    btnObter.innerHTML = '<span>üìç</span> Obter Localiza√ß√£o';
  }, 20000); // 20 segundos

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      clearTimeout(timeoutId);
      const fim = new Date();
      const cfg = obterConfig();
      const origem = classificarOrigem(pos.coords.accuracy, cfg);

      const registro = {
        data: fim.toLocaleString('pt-BR'),
        timestamp: fim.getTime(),
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        precisao: Math.round(pos.coords.accuracy),
        altitude: pos.coords.altitude,
        altitudePrecisao: pos.coords.altitudeAccuracy,
        heading: pos.coords.heading,
        velocidade: pos.coords.speed,
        duracao_ms: fim - inicio,
        origem: origem.tipo
      };

      salvarHistorico(registro);

      output.textContent = JSON.stringify({
        status: "‚úÖ SUCESSO",
        inicio: inicio.toISOString(),
        fim: fim.toISOString(),
        duracao_ms: fim - inicio,
        latitude: registro.lat,
        longitude: registro.lon,
        precisao_metros: registro.precisao,
        origem_estimada: registro.origem,
        altitude_metros: registro.altitude,
        velocidade_ms: registro.velocidade,
        navegador: navigator.userAgent.split(' ').pop()
      }, null, 2);

      const mapsUrl = `https://www.google.com/maps?q=${registro.lat},${registro.lon}`;
      mapsDiv.innerHTML = `
        <div class="box success">
          <strong>üó∫Ô∏è Localiza√ß√£o Obtida com Sucesso!</strong><br>
          <span class="badge badge-${origem.classe}">${origem.tipo}</span><br>
          Precis√£o: ${registro.precisao} metros<br>
          <a href="${mapsUrl}" target="_blank">üìç Abrir no Google Maps</a>
        </div>
      `;
      
      btnObter.disabled = false;
      btnObter.innerHTML = '<span>üìç</span> Obter Localiza√ß√£o';
    },
    (err) => {
      clearTimeout(timeoutId);
      const mensagensErro = {
        1: "Permiss√£o negada pelo usu√°rio",
        2: "Posi√ß√£o indispon√≠vel (verifique se o GPS est√° ativo)",
        3: "Tempo limite excedido (sinal fraco ou GPS desligado)"
      };
      
      output.innerHTML = `<div class="box error">
        <strong>‚ùå Erro ao obter localiza√ß√£o</strong><br>
        <strong>C√≥digo:</strong> ${err.code}<br>
        <strong>Motivo:</strong> ${mensagensErro[err.code] || err.message}<br>
        <strong>Mensagem t√©cnica:</strong> ${err.message}<br><br>
        <strong>Dicas:</strong><br>
        - Verifique se o GPS est√° ativado no dispositivo<br>
        - Certifique-se de que o site tem permiss√£o para acessar sua localiza√ß√£o<br>
        - Se estiver em ambiente fechado, tente pr√≥ximo a uma janela<br>
        - Recarregue a p√°gina e tente novamente
      </div>`;
      
      btnObter.disabled = false;
      btnObter.innerHTML = '<span>üìç</span> Obter Localiza√ß√£o';
    },
    { 
      enableHighAccuracy: true, 
      timeout: 15000, 
      maximumAge: 0 
    }
  );
}

async function obterMultiplas() {
  const btnMultiplas = document.getElementById("btnMultiplas");
  btnMultiplas.disabled = true;
  btnMultiplas.innerHTML = '<span class="loading"></span> Obtendo...';
  
  for (let i = 0; i < 5; i++) {
    await new Promise(resolve => {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const cfg = obterConfig();
          const origem = classificarOrigem(pos.coords.accuracy, cfg);
          const agora = new Date();
          
          salvarHistorico({
            data: agora.toLocaleString('pt-BR'),
            timestamp: agora.getTime(),
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            precisao: Math.round(pos.coords.accuracy),
            altitude: pos.coords.altitude,
            velocidade: pos.coords.speed,
            duracao_ms: 0,
            origem: origem.tipo
          });
          
          resolve();
        },
        () => resolve(),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
    
    await new Promise(r => setTimeout(r, 1000));
  }
  
  btnMultiplas.disabled = false;
  btnMultiplas.innerHTML = '<span>üìä</span> Obter 5 Consecutivas';
}

function exportarJSON() {
  const dados = JSON.parse(localStorage.getItem("geo_historico_v2")) || [];
  const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `geolocalizacao_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function exportarCSV() {
  const dados = JSON.parse(localStorage.getItem("geo_historico_v2")) || [];
  
  const headers = ['Data', 'Latitude', 'Longitude', 'Precis√£o (m)', 'Origem', 'Dura√ß√£o (ms)', 'Duplicata'];
  const rows = dados.map(d => [
    d.data,
    d.lat,
    d.lon,
    d.precisao,
    d.origem,
    d.duracao_ms,
    d.duplicata ? 'Sim' : 'N√£o'
  ]);
  
  const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `geolocalizacao_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function copiarParaClipboard() {
  const dados = JSON.parse(localStorage.getItem("geo_historico_v2")) || [];
  const texto = JSON.stringify(dados, null, 2);
  
  navigator.clipboard.writeText(texto).then(() => {
    alert('‚úÖ Dados copiados para a √°rea de transfer√™ncia!');
  }).catch(() => {
    alert('‚ùå Erro ao copiar dados.');
  });
}

// Carregar hist√≥rico ao iniciar
carregarHistorico();
</script>

</body>
</html>