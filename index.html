<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teste T√©cnico ‚Äì Geolocaliza√ß√£o v3</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,.1);
}
h1,h2 { color:#2c3e50; }
button {
  padding: 10px 16px;
  margin: 5px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.btn-primary { background:#3498db; color:#fff; }
.btn-danger { background:#e74c3c; color:#fff; }
.btn-secondary { background:#95a5a6; color:#fff; }
.box {
  border:1px solid #ddd;
  border-radius:8px;
  padding:15px;
  margin-bottom:20px;
}
.warning { background:#fff9e6; border-color:#f39c12; }
.success { background:#e8f5e9; border-color:#27ae60; }
.error { background:#fdecea; border-color:#e74c3c; }
.info { background:#e8f4f8; border-color:#3498db; }
pre {
  background:#2c3e50;
  color:#ecf0f1;
  padding:15px;
  border-radius:6px;
  overflow-x:auto;
}
.history-item {
  border-bottom:1px dashed #ccc;
  padding:10px 0;
  display:flex;
  justify-content:space-between;
}
.delete-btn {
  cursor:pointer;
  color:#c0392b;
  font-weight:bold;
}
.badge {
  display:inline-block;
  padding:4px 10px;
  border-radius:12px;
  font-size:.8em;
  color:#fff;
  margin-left:6px;
}
.badge-gps { background:#27ae60; }
.badge-wifi { background:#3498db; }
.badge-wifi-aprox { background:#f39c12; }
.badge-ip { background:#7f8c8d; }
.badge-ipcorp { background:#2c3e50; }
</style>
</head>

<body>
<div class="container">

<h1>üåç Teste T√©cnico de Geolocaliza√ß√£o ‚Äì v3</h1>

<div class="box warning">
<strong>Objetivo</strong><br>
Ferramenta de diagn√≥stico para identificar a origem prov√°vel da geolocaliza√ß√£o
(GPS, Wi-Fi ou IP), avaliar repeti√ß√£o de coordenadas e gerar evid√™ncia t√©cnica
para redes, seguran√ßa e auditoria.
</div>

<div class="box info">
<strong>Configura√ß√£o de Infer√™ncia (heur√≠stica)</strong><br><br>
GPS at√© <input type="number" id="gpsMax" value="20"> m |
Wi-Fi at√© <input type="number" id="wifiMax" value="200"> m |
Wi-Fi aprox at√© <input type="number" id="wifiAproxMax" value="1000"> m
</div>

<button class="btn-primary" onclick="obterLocalizacao()">üìç Obter Localiza√ß√£o</button>
<button class="btn-secondary" onclick="obterMultiplas()">üìä 5 Consecutivas</button>
<button class="btn-danger" onclick="limparHistorico()">üóëÔ∏è Limpar Hist√≥rico</button>

<h2>üìä Resultado Atual</h2>
<pre id="resultado">Aguardando...</pre>

<h2>üïò Hist√≥rico</h2>
<div class="box" id="historico"></div>

<h2>üìà Estat√≠sticas</h2>
<div class="box" id="stats"></div>

</div>

<script>
const STORAGE = "geo_hist_v3";
const LIMITE = 50;
const DUP_DIST = 10;

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
            Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function cfgAtual() {
  return {
    gpsMax:+gpsMax.value,
    wifiMax:+wifiMax.value,
    wifiAproxMax:+wifiAproxMax.value
  };
}

function classificar(accuracy, cfg) {
  if (accuracy <= cfg.gpsMax) return {tipo:"GPS", classe:"gps", fonte:"SENSOR"};
  if (accuracy <= cfg.wifiMax) return {tipo:"Wi-Fi", classe:"wifi", fonte:"WIFI_TRIANGULATION"};
  if (accuracy <= cfg.wifiAproxMax) return {tipo:"Wi-Fi Aproximado", classe:"wifi-aprox", fonte:"WIFI_TRIANGULATION"};
  return {tipo:"IP", classe:"ip", fonte:"IP_LOOKUP"};
}

function salvar(reg) {
  const hist = JSON.parse(localStorage.getItem(STORAGE)) || [];
  if (hist.length) {
    const d = haversine(hist[0].lat, hist[0].lon, reg.lat, reg.lon);
    reg.distanciaAnterior = d;
    reg.duplicata = d < DUP_DIST;
    if (reg.fonte==="IP_LOOKUP" && reg.duplicata) {
      reg.ipCorporativoProvavel = true;
    }
  }
  hist.unshift(reg);
  if (hist.length > LIMITE) hist.pop();
  localStorage.setItem(STORAGE, JSON.stringify(hist));
  render();
}

function obterLocalizacao() {
  const out = document.getElementById("resultado");
  const ini = Date.now();
  navigator.geolocation.getCurrentPosition(
    pos => {
      const cfg = cfgAtual();
      const ori = classificar(pos.coords.accuracy, cfg);
      const reg = {
        data:new Date().toLocaleString(),
        lat:pos.coords.latitude,
        lon:pos.coords.longitude,
        precisao:Math.round(pos.coords.accuracy),
        origem:ori.tipo,
        origemClasse:ori.classe,
        fonte:ori.fonte,
        cfg,
        duracao_ms:Date.now()-ini
      };
      salvar(reg);
      out.textContent = JSON.stringify(reg,null,2);
    },
    err => {
      const tipo =
        err.code===1 ? "DECISAO_USUARIO" :
        err.code===2 ? "AMBIENTE_REDE" :
        "CONDICAO_TEMPORARIA";
      out.textContent = JSON.stringify({
        erro:err.code,
        tipo,
        mensagem:err.message
      },null,2);
    },
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

async function obterMultiplas() {
  for (let i=0;i<5;i++) {
    await new Promise(r=>{
      navigator.geolocation.getCurrentPosition(p=>{
        const cfg = cfgAtual();
        const ori = classificar(p.coords.accuracy, cfg);
        salvar({
          data:new Date().toLocaleString(),
          lat:p.coords.latitude,
          lon:p.coords.longitude,
          precisao:Math.round(p.coords.accuracy),
          origem:ori.tipo,
          origemClasse:ori.classe,
          fonte:ori.fonte,
          cfg,
          duracao_ms:0
        });
        r();
      },()=>r());
    });
    await new Promise(r=>setTimeout(r,1000));
  }
}

function limparHistorico() {
  if (confirm("Excluir todo o hist√≥rico?")) {
    localStorage.removeItem(STORAGE);
    render();
  }
}

function excluir(i) {
  const h = JSON.parse(localStorage.getItem(STORAGE))||[];
  h.splice(i,1);
  localStorage.setItem(STORAGE, JSON.stringify(h));
  render();
}

function render() {
  const hist = JSON.parse(localStorage.getItem(STORAGE))||[];
  const hDiv = document.getElementById("historico");
  if (!hist.length) { hDiv.innerHTML="Sem registros."; return; }
  hDiv.innerHTML="";
  hist.forEach((r,i)=>{
    const map=`https://www.google.com/maps?q=${r.lat},${r.lon}`;
    hDiv.innerHTML+=`
      <div class="history-item">
        <div>
          <strong>${i+1}. ${r.data}</strong>
          <span class="badge badge-${r.origemClasse}">${r.origem}</span>
          ${r.ipCorporativoProvavel?'<span class="badge badge-ipcorp">IP CORP.</span>':''}
          <br>Lat: ${r.lat} | Lon: ${r.lon}
          <br>Precis√£o: ${r.precisao} m
          ${r.distanciaAnterior!==undefined?'<br>Œî anterior: '+r.distanciaAnterior.toFixed(1)+' m':''}
          <br><a href="${map}" target="_blank">Abrir no Maps</a>
        </div>
        <div class="delete-btn" onclick="excluir(${i})">‚úñ</div>
      </div>`;
  });

  const p = hist.map(x=>x.precisao);
  const dup = hist.filter(x=>x.duplicata).length;
  document.getElementById("stats").innerHTML =
    `Total: ${hist.length} | M√©dia precis√£o: ${(p.reduce((a,b)=>a+b,0)/p.length).toFixed(1)} m | Duplicatas: ${dup}`;
}

render();
</script>
</body>
</html>
